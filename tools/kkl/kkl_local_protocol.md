
# KKL Control Protocol

Starting from version v100.2, KKL comes with an optional built-in TCP server allowing for remote control of a running KKL instance.

## Enabling the server

The remote-control server is disabled by default; on startup, `KKL.exe` will look for a file named `enable_server` in the same 
directory as itself.

If this file exists, KKL will attempt to bind to port `8008` on `127.0.0.1`. If it fails to bind to the port, the server will
silently disable itself for that session.

## Protocol Overview

_Note: a simple example of a protocol client implementation (in Python) can be found alongside this document._

In the following documentation, the _server_ refers to the KKL instance.

All messages transmitted between client and server begin with the following 9-byte header:

| Offset | Length | Data                | Description |
| ------ | ------ | ------------------- | ----------- |
| 0      | 4      | Protocol header     | "KKL " (note the trailing space), in ASCII / UTF-8
| 4      | 1      | Message type        | See below
| 5      | 4      | Payload data length | Does not include header data

## Message Types

| Byte Value | Message Type  | Sent By | Description |
| ---------- | ------------- | ------- | ----------- |
| 0x01       | Command       | Client  | Instructs the server KKL instance to perform some action.
| 0x02       | Cmd. Response | Server  | Sent by the server in response to a Command message. The server will send multiple response packets for a given command.
| 0x03       | Image Data    | Server  | Contains the final output image generated by an Import or Screenshot command.
| 0x04       | Heartbeat     | Server  | The server will send these roughly every 5 seconds after establishing a connection with a client.

### Command Messages

The payload of a Command message is a UTF-8 string containing a JSON-serialized object, with the following schema:

```
{
    "type": "import" | "import_partial" | "screenshot" | "reset_full" | "reset_partial",  (required)
    "id": number, (optional)
    "code": string, (required if type == "import" or "import_partial", ignored otherwise)
    "bg": boolean, (optional, only used if type == "screenshot")
}
```

 * **Import** commands instruct KKL to import a code and generate a screenshot of it, similarly to the traditional file-based image export flow.
 * **Partial Import** commands only cause a code to be imported into the Kisekae workspace. They do not cause a screenshot to be taken.
 * **Screenshot** commands take a screenshot of the Kisekae workspace.
 * **Reset** commands instruct KKL to reset the scene prop, background, and camera settings. A "full" reset will also hide all but the first character in the Kisekae lineup. This is useful for making standard pose images.

The `"id"` parameter does not affect processing on its own, but the server will attach it to all outgoing messages related to the request.

The `"code"` parameter, for Import commands, is a Kisekae code. For the full Import command (that takes screenshots), adding alpha parameters should work just as in regular file-based imports.
(Alpha parameters aren't supported for partial imports yet.)

The `"bg"` parameter, for Screenshot commands, controls whether to show the background in the screenshot or not.
By default, the background will be hidden (i.e. the default is `"bg": false`).

Commands that take screenshots will send them back to the client via an Image Data message; all other responses take the form of Command Response messages.

### Command Response Messages

The payload of a Command Response message is also a UTF-8 string containing a JSON-serialized object.
These objects have the following schema:

```
{
    "status": "in_progress" | "done",
    "id": number (optional)
}
```

The `"id"` parameter indicates what request this response corresponds to; if the original request had no associated `"id"`, then it will be set to 0.

Upon receiving a request, the server will first send a response with `"status": "in_progress"` to indicate that it has received the request. 

Once a given request is complete, the server will send another response with `"status": "done"` to indicate success for Reset commands.

### Image Data Messages

Success for Import commands is indicated via an Image Data message, which contains the following data:

| Offset | Length   | Data              | Description |
| ------ | -------- | ----------------- | ----------- |
| 9      | 4        | Identifier        | The `"id"` parameter sent with the original request.
| 13     | Variable | Image data        | This is the PNG-encoded data that KKL would normally write to a file after importing.

### Heartbeat Messages

The server will send heartbeat messages to all connected clients roughly every five seconds (though KKL lag and runtime freezes may cause heartbeats to be delayed).

Heartbeat messages have no payload and have a payload data length of 0.
