stages:
    - test
    - deploy
    - bundle

run_tests:
    stage: test
    tags:
        - testing
    only:
        refs:
            - branches
            - merge_requests
        changes:
            - .gitlab-ci.yml
            - config.xml
            - index.html
            - css/*
            - js/*
            - tests/**/*
    script:
         # note: should probably do something like prepare-online.sh, but that would take a long time...
        - cd tests/
        - pipenv sync
        # Note: for some reason, leaving the screen resolution at default causes Chrome to crash during tests.
        - xvfb-run -a --server-args "-screen 0 1024x768x16" ./run-tests.sh
    interruptible: true

deploy_production:
    stage: deploy
    tags:
        - production
    script:
        - export VERSION=$(git describe --first-parent $CI_COMMIT_SHA)
        - sentry-cli releases new -p spnati $VERSION
        - bash ./prepare-online.sh
        - rsync -crltz --out-format=%n --delete .public/ /opt/spnati | python3 ./deploy-scripts/purge_cf_cache.py
        - sentry-cli releases set-commits --auto $VERSION
        - sentry-cli releases finalize $VERSION
        - sentry-cli releases deploys $VERSION new -e production
    environment:
        name: production
        url: https://spnati.net/
    only:
        - master@spnati/spnati

bundle_packages:
    stage: bundle
    tags:
        - production
    script:
        - mkdir -p ./bundle-page/dl
        - python3 ./deploy-scripts/bundle.py ./ ./bundle-page/dl generate
        - rsync -rltz --delete ./bundle-page/ /opt/spnati-bundles
    only:
        - master@spnati/spnati
